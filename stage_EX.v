`timescale 1ns / 1ps
//////////////////////////////////////////////////////////////////////////////////
// Company:
// Engineer:
//
// Create Date: 2018/03/08 17:54:41
// Design Name:
// Module Name: stage_EX
// Project Name:
// Target Devices:
// Tool Versions:
// Description:
//
// Dependencies:
//
// Revision:
// Revision 0.01 - File Created
// Additional Comments:
//
//////////////////////////////////////////////////////////////////////////////////

`define WORD 32  // 1word
`define WORD_ADDR_W 30  // address width 1word

`define GPR_ADDR_MSB 5-1

`define WORD_MSB `WORD-1
`define WORD_ADDR_MSB `WORD_ADDR_W-1
`define RegAddrBus `GPR_ADDR_MSB:0


module reg_EX (
input  wire				   clk,			   // ????ｽN????ｽ????ｽ????ｽb????ｽN
input  wire				   rst,		   // ????ｽ同奇ｿｽ????ｽ????ｽ????ｽZ????ｽb????ｽg
/********** ????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽM????ｽ????ｽ **********/
input  wire				   stall,		   // ????ｽX????ｽg????ｽ[????ｽ????ｽ
input  wire				   flush,		   // ????ｽt????ｽ????ｽ????ｽb????ｽV????ｽ????ｽ
input  wire				   int_detect,	   // ????ｽ????ｽ????ｽ闕橸ｿｽﾝ鯉ｿｽ????ｽo
/********** ????ｽt????ｽH????ｽ????ｽ????ｽ[????ｽf????ｽB????ｽ????ｽ????ｽO **********/
output wire [`WORD_MSB:0] fwd_data,	   // ????ｽt????ｽH????ｽ????ｽ????ｽ[????ｽf????ｽB????ｽ????ｽ????ｽO????ｽf????ｽ[????ｽ^
/********** ID/EX????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽ????ｽ????ｽW????ｽX????ｽ^ **********/
input  wire [`WORD_ADDR_MSB:0] id_pc,		   // ????ｽv????ｽ????ｽ????ｽO????ｽ????ｽ????ｽ????ｽ????ｽJ????ｽE????ｽ????ｽ????ｽ^
input  wire				   id_en,		   // ????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽf????ｽ[????ｽ^????ｽﾌ有????ｽ????ｽ
input  wire 	   alu_of,	   // ALU????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
input  wire [`WORD_MSB:0] alu_out,	   // ALU????ｽ????ｽ????ｽ????ｽ 0
input  wire				   id_br_flag,	   // ????ｽ????ｽ????ｽ????ｽ????ｽt????ｽ????ｽ????ｽO
input  wire [1:0]	   id_mem_op,	   // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
input  wire [`WORD_MSB:0] id_mem_wr_data, // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝデ????ｽ[????ｽ^
input  wire [1:0]   id_ctrl_op,	   // ????ｽ????ｽ????ｽ艫鯉ｿｽW????ｽX????ｽ^????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
input  wire [`RegAddrBus]  id_dst_addr,	   // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝア????ｽh????ｽ????ｽ????ｽX
input  wire				   id_gpr_we_,	   // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝ有????ｽ????ｽ
input  wire [2:0]   id_exp_code,	   // ????ｽ????ｽ????ｽO????ｽR????ｽ[????ｽh
/********** EX/MEM????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽ????ｽ????ｽW????ｽX????ｽ^ **********/
output reg [`WORD_ADDR_MSB:0] ex_pc,		   // ????ｽv????ｽ????ｽ????ｽO????ｽ????ｽ????ｽ????ｽ????ｽJ????ｽE????ｽ????ｽ????ｽ^
output reg				   ex_en,		   // ????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽf????ｽ[????ｽ^????ｽﾌ有????ｽ????ｽ
output reg				   ex_br_flag,	   // ????ｽ????ｽ????ｽ????ｽ????ｽt????ｽ????ｽ????ｽO
output reg [1:0]	   ex_mem_op,	   // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
output reg [`WORD_MSB:0] ex_mem_wr_data, // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝデ????ｽ[????ｽ^
output reg [1:0]   ex_ctrl_op,	   // ????ｽ????ｽ????ｽ艫鯉ｿｽW????ｽX????ｽ^????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
output reg [`RegAddrBus]  ex_dst_addr,	   // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝア????ｽh????ｽ????ｽ????ｽX
output reg				   ex_gpr_we_,	   // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝ有????ｽ????ｽ
output reg [2:0]   ex_exp_code,	   // ????ｽ????ｽ????ｽO????ｽR????ｽ[????ｽh
output reg [`WORD_MSB:0] ex_out		   // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ
);


		  always@(posedge clk or negedge rst)begin//bus access control
		    if(~rst)begin
		      ex_pc<=0;
		      ex_en<=0;
					ex_br_flag<=0;
					ex_mem_op<=0;
					ex_mem_wr_data<=0;
					ex_ctrl_op<=0;
					ex_dst_addr<=0;
					ex_gpr_we_<=0;
					ex_exp_code<=0;
          ex_out<=0;
				end
		    else if(~stall)begin
					if(flush)begin
						ex_pc<=0;
		      	ex_en<=0;
						ex_br_flag<=0;
						ex_mem_op<=0;
						ex_mem_wr_data<=0;
						ex_ctrl_op<=0;
						ex_dst_addr<=0;
						ex_gpr_we_<=0;
						ex_exp_code<=0;
            ex_out<=0;
					end
          else if (int_detect)begin
						ex_pc<=id_pc;
						ex_en<=id_en;
						ex_br_flag<=id_br_flag;
						ex_mem_op<=0;
						ex_mem_wr_data<=0;
						ex_ctrl_op<=0;
						ex_dst_addr<=0;
						ex_gpr_we_<=0;
						ex_exp_code<=1;//interrupt
            ex_out<=0;
          end
          else if (alu_of)begin
						ex_pc<=id_pc;
						ex_en<=id_en;
						ex_br_flag<=id_br_flag;
						ex_mem_op<=0;
						ex_mem_wr_data<=0;
						ex_ctrl_op<=0;
						ex_dst_addr<=0;
						ex_gpr_we_<=0;
						ex_exp_code<=3;//overflow
            ex_out<=0;
          end

					else begin
						ex_pc<=id_pc;
						ex_en<=id_en;
						ex_br_flag<=id_br_flag;
						ex_mem_op<=id_mem_op;
						ex_mem_wr_data<=id_mem_wr_data;
						ex_ctrl_op<=id_ctrl_op;
						ex_dst_addr<=id_dst_addr;
						ex_gpr_we_<=id_gpr_we_;
						ex_exp_code<=id_exp_code;
            ex_out<=alu_out;
					end
				end
			end

endmodule //reg_EX


module stage_EX(

  	/********** ????ｽN????ｽ????ｽ????ｽb????ｽN & ????ｽ????ｽ????ｽZ????ｽb????ｽg **********/
  	input  wire				   clk,			   // ????ｽN????ｽ????ｽ????ｽb????ｽN
  	input  wire				   reset,		   // ????ｽ同奇ｿｽ????ｽ????ｽ????ｽZ????ｽb????ｽg
  	/********** ????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽM????ｽ????ｽ **********/
  	input  wire				   stall,		   // ????ｽX????ｽg????ｽ[????ｽ????ｽ
  	input  wire				   flush,		   // ????ｽt????ｽ????ｽ????ｽb????ｽV????ｽ????ｽ
  	input  wire				   int_detect,	   // ????ｽ????ｽ????ｽ闕橸ｿｽﾝ鯉ｿｽ????ｽo
		input [`WORD_MSB:0] fwd_data,
		input  wire [`WORD_ADDR_MSB:0] id_pc,		   // ????ｽv????ｽ????ｽ????ｽO????ｽ????ｽ????ｽ????ｽ????ｽJ????ｽE????ｽ????ｽ????ｽ^
  	input  wire				   id_en,		   // ????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽf????ｽ[????ｽ^????ｽﾌ有????ｽ????ｽ
  	input  wire				   id_br_flag,	   // ????ｽ????ｽ????ｽ????ｽ????ｽt????ｽ????ｽ????ｽO
    input[3:0] id_alu_op,
    input[`WORD_MSB:0] id_alu_in_0,
    input[`WORD_MSB:0] id_alu_in_1,
  	input  wire [1:0]	   id_mem_op,	   // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
  	input  wire [`WORD_MSB:0] id_mem_wr_data, // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝデ????ｽ[????ｽ^
  	input  wire [1:0]   id_ctrl_op,	   // ????ｽ????ｽ????ｽ艫鯉ｿｽW????ｽX????ｽ^????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
  	input  wire [`RegAddrBus]  id_dst_addr,	   // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝア????ｽh????ｽ????ｽ????ｽX
  	input  wire				   id_gpr_we_,	   // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝ有????ｽ????ｽ
  	input  wire [2:0]   id_exp_code,	   // ????ｽ????ｽ????ｽO????ｽR????ｽ[????ｽh
  	/********** EX/MEM????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽ????ｽ????ｽW????ｽX????ｽ^ **********/
  	output reg [`WORD_ADDR_MSB:0] ex_pc,		   // ????ｽv????ｽ????ｽ????ｽO????ｽ????ｽ????ｽ????ｽ????ｽJ????ｽE????ｽ????ｽ????ｽ^
  	output reg				   ex_en,		   // ????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽf????ｽ[????ｽ^????ｽﾌ有????ｽ????ｽ
  	output reg				   ex_br_flag,	   // ????ｽ????ｽ????ｽ????ｽ????ｽt????ｽ????ｽ????ｽO
  	output reg [1:0]	   ex_mem_op,	   // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
  	output reg [`WORD_MSB:0] ex_mem_wr_data, // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝデ????ｽ[????ｽ^
  	output reg [1:0]   ex_ctrl_op,	   // ????ｽ????ｽ????ｽ艫鯉ｿｽW????ｽX????ｽ^????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
  	output reg [`RegAddrBus]  ex_dst_addr,	   // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝア????ｽh????ｽ????ｽ????ｽX
  	output reg				   ex_gpr_we_,	   // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝ有????ｽ????ｽ
  	output reg [2:0]   ex_exp_code,	   // ????ｽ????ｽ????ｽO????ｽR????ｽ[????ｽh
  	output reg [`WORD_MSB:0] ex_out		   // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ
  );

  	/********** ALU????ｽﾌ出????ｽ????ｽ **********/
  	wire [`WORD_MSB:0]		   alu_out;		   // ????ｽ????ｽ????ｽZ????ｽ????ｽ????ｽ????ｽ
  	wire					   alu_of;		   // ????ｽI????ｽ[????ｽo????ｽt????ｽ????ｽ????ｽ[

  	/********** ????ｽ????ｽ????ｽZ????ｽ????ｽ????ｽﾊのフ????ｽH????ｽ????ｽ????ｽ[????ｽf????ｽB????ｽ????ｽ????ｽO **********/

  	/********** ALU **********/
  	ALU alu (
  		.in_0			(id_alu_in_0),	  // ????ｽ????ｽ????ｽ????ｽ 0
  		.in_1			(id_alu_in_1),	  // ????ｽ????ｽ????ｽ????ｽ 1
  		.op				(id_alu_op),	  // ????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
  		.out			(alu_out),		  // ????ｽo????ｽ????ｽ
  		.of				(alu_of)		  // ????ｽI????ｽ[????ｽo????ｽt????ｽ????ｽ????ｽ[
  	);

  	/********** ????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽ????ｽ????ｽW????ｽX????ｽ^ **********/
  	reg_EX ex_reg (
  		/********** ????ｽN????ｽ????ｽ????ｽb????ｽN & ????ｽ????ｽ????ｽZ????ｽb????ｽg **********/
  		.clk			(clk),			  // ????ｽN????ｽ????ｽ????ｽb????ｽN
  		.rst			(reset),		  // ????ｽ同奇ｿｽ????ｽ????ｽ????ｽZ????ｽb????ｽg
  		/********** ALU????ｽﾌ出????ｽ????ｽ **********/
  		.alu_out		(alu_out),		  // ????ｽ????ｽ????ｽZ????ｽ????ｽ????ｽ????ｽ
  		.alu_of			(alu_of),		  // ????ｽI????ｽ[????ｽo????ｽt????ｽ????ｽ????ｽ[
  		/********** ????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽM????ｽ????ｽ **********/
  		.stall			(stall),		  // ????ｽX????ｽg????ｽ[????ｽ????ｽ
  		.flush			(flush),		  // ????ｽt????ｽ????ｽ????ｽb????ｽV????ｽ????ｽ
  		.int_detect		(int_detect),	  // ????ｽ????ｽ????ｽ闕橸ｿｽﾝ鯉ｿｽ????ｽo
  		/********** ID/EX????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽ????ｽ????ｽW????ｽX????ｽ^ **********/
			.fwd_data (fwd_data),
  		.id_pc			(id_pc),		  // ????ｽv????ｽ????ｽ????ｽO????ｽ????ｽ????ｽ????ｽ????ｽJ????ｽE????ｽ????ｽ????ｽ^
  		.id_en			(id_en),		  // ????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽf????ｽ[????ｽ^????ｽﾌ有????ｽ????ｽ
  		.id_br_flag		(id_br_flag),	  // ????ｽ????ｽ????ｽ????ｽ????ｽt????ｽ????ｽ????ｽO
  		.id_mem_op		(id_mem_op),	  // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
  		.id_mem_wr_data (id_mem_wr_data), // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝデ????ｽ[????ｽ^
  		.id_ctrl_op		(id_ctrl_op),	  // ????ｽ????ｽ????ｽ艫鯉ｿｽW????ｽX????ｽ^????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
  		.id_dst_addr	(id_dst_addr),	  // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝア????ｽh????ｽ????ｽ????ｽX
  		.id_gpr_we_		(id_gpr_we_),	  // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝ有????ｽ????ｽ
  		.id_exp_code	(id_exp_code),	  // ????ｽ????ｽ????ｽO????ｽR????ｽ[????ｽh
  		/********** EX/MEM????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽ????ｽ????ｽW????ｽX????ｽ^ **********/
  		.ex_pc			(ex_pc),		  // ????ｽv????ｽ????ｽ????ｽO????ｽ????ｽ????ｽ????ｽ????ｽJ????ｽE????ｽ????ｽ????ｽ^
  		.ex_en			(ex_en),		  // ????ｽp????ｽC????ｽv????ｽ????ｽ????ｽC????ｽ????ｽ????ｽf????ｽ[????ｽ^????ｽﾌ有????ｽ????ｽ
  		.ex_br_flag		(ex_br_flag),	  // ????ｽ????ｽ????ｽ????ｽ????ｽt????ｽ????ｽ????ｽO
  		.ex_mem_op		(ex_mem_op),	  // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
  		.ex_mem_wr_data (ex_mem_wr_data), // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝデ????ｽ[????ｽ^
  		.ex_ctrl_op		(ex_ctrl_op),	  // ????ｽ????ｽ????ｽ艫鯉ｿｽW????ｽX????ｽ^????ｽI????ｽy????ｽ????ｽ????ｽ[????ｽV????ｽ????ｽ????ｽ????ｽ
  		.ex_dst_addr	(ex_dst_addr),	  // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝア????ｽh????ｽ????ｽ????ｽX
  		.ex_gpr_we_		(ex_gpr_we_),	  // ????ｽﾄ用????ｽ????ｽ????ｽW????ｽX????ｽ^????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽﾝ有????ｽ????ｽ
  		.ex_exp_code	(ex_exp_code),	  // ????ｽ????ｽ????ｽO????ｽR????ｽ[????ｽh
  		.ex_out			(ex_out)		  // ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ????ｽ
  	);

endmodule
