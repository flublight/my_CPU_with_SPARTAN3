`timescale 1ns / 1ps
//////////////////////////////////////////////////////////////////////////////////
// Company:
// Engineer:
//
// Create Date: 2018/03/07 16:35:44
// Design Name:
// Module Name: bus_IF
// Project Name:
// Target Devices:
// Tool Versions:
// Description:
//
// Dependencies:
//
// Revision:
// Revision 0.01 - File Created
// Additional Comments:
//
//////////////////////////////////////////////////////////////////////////////////

`define WORD 32  // 1word
`define WORD_ADDR_W 30  // address width 1word

`define WORD_MSB `WORD-1
`define WORD_ADDR_MSB `WORD_ADDR_W-1

module reg_IF (
  input clk,
  input rst,
  input[`WORD_ADDR_MSB:0] inst,//fetch data(instraction)

  input stall,
  input flush,
  input[`WORD_ADDR_MSB:0] new_pc,
  input br_taken,
  input[`WORD_ADDR_MSB:0] br_addr,

  output reg[`WORD_ADDR_MSB:0] if_pc,
  output reg[`WORD_MSB:0] if_inst,
  output reg if_en
  );


  always@(posedge clk or negedge rst)begin//bus access control
    if(~rst)begin
      if_pc<=new_pc;
      if_inst<=0;//NOP
      if_en<=0;
    end
    else begin
      if(~stall)begin
        if(flush)begin
        if_pc<=new_pc;
        if_inst<=0;//NOP
        if_en<=0;
        end
        else if(br_taken)begin//branch
        if_pc<=br_addr;
        if_inst<=inst;//
        if_en<=1;
        end
        else begin
        if_pc<=if_pc+1;
        if_inst<=inst;//
        if_en<=1;
        end
      end
    end
 end
endmodule //if_reg

module bus_IF(
    input clk,
    input rst,
    input stall,
    input flush,
    output reg busy,
    //cpu_interface
    input [`WORD_ADDR_MSB:0]addr,
    input as,
    input rw,
    output reg [`WORD_MSB:0]rd_data,
    input [`WORD_MSB:0]wr_data,
    //spm
    input [`WORD_MSB:0]spm_rd_data,
    output [`WORD_ADDR_MSB:0]spm_addr,
    output reg spm_as,
    output spm_rw,
    output [`WORD_MSB:0]spm_wr_data,
    //bus
    input [`WORD_MSB:0]bus_rd_data,
    input bus_rdy,
    input bus_grnt,
    output reg[`WORD_ADDR_MSB:0]bus_addr,
    output reg[`WORD_MSB:0]bus_wr_data,
    output reg bus_req,
    output reg bus_rw,
    output reg bus_as
    );
reg [1:0]state;//0:idle,1:bus_req,2:bus_access,3:stull
reg[`WORD_MSB:0]rd_buf;
wire s_index;
assign s_index = addr[29:27];//slave_index

assign spm_rw=rw;
assign spm_wr_data=wr_data;
assign spm_addr=addr;



always@(*)begin//memory access control
      rd_data=0;
      spm_as=0;
      busy=0;
      case(state)
      0:begin
        if(~flush&&as)
          if(s_index==1)begin
            if(~stall)begin
              spm_as=1;
              if(rw==0)rd_data=spm_rd_data;//read
            end
          end
          else busy=1;
        end

      1:busy=1;

      2:begin
        if(bus_rdy)begin
          if(rw==0)rd_data=bus_rd_data;//read
        end
        else busy=1;
        end

      3:if(rw==0)rd_data=rd_buf;

      endcase
    end
    always@(posedge clk or negedge rst)begin//bus access control
      if(~rst)begin
        state<=0;
        bus_req<=0;
        bus_addr<=0;
        bus_as<=0;
        bus_rw<=0;
        bus_wr_data<=0;
        rd_buf<=0;
      end
      else begin
          case (state)
          0:
          if(~flush&&as)
            if(s_index!=1)begin
              state<=1;
              bus_req<=1;
              bus_addr<=addr;
              bus_rw<=rw;
              bus_wr_data<=wr_data;
          end
            1:if(bus_grnt)begin
                state<=2;
                bus_as<=1;
              end
            2:begin
                bus_as<=0;
                if(bus_rdy)begin
                bus_req<=0;
                bus_addr<=0;
                bus_rw<=0;
                bus_wr_data<=0;
                //store read data
                if(bus_rw==0)rd_buf<=bus_rd_data;

                //check stall
                if(stall)state<=3;
                else state<=0;
                end
              end

            3:if(~stall)state<=0;
          endcase
        end
     end
endmodule


module stage_IF (
	/********** ?½?½N?½?½?½?½?½?½b?½?½N & ?½?½?½?½?½?½Z?½?½b?½?½g **********/
	input  wire				   clk,			// ?½?½N?½?½?½?½?½?½b?½?½N
	input  wire				   reset,		// ?½?½û Žï½¯å¥?½¿?½?½?½?½?½?½?½Z?½?½b?½?½g
	/********** SPM?½?½C?½?½?½?½?½?½^?½?½t?½?½F?½?½[?½?½X **********/
	input  wire [`WORD_MSB:0] spm_rd_data, // ?½?½??¿å‡º?½?½?½?½?½?½f?½?½[?½?½^
	output wire [`WORD_ADDR_MSB:0] spm_addr,	// ?½?½A?½?½h?½?½?½?½?½?½X
	output wire				   spm_as_,		// ?½?½A?½?½h?½?½?½?½?½?½X?½?½X?½?½g?½?½?½?½?½?½[?½?½u
	output wire				   spm_rw,		// ?½?½??¿?ï¿½?½?½?½?½?½?½?½
	output wire [`WORD_MSB:0] spm_wr_data, // ?½?½?½?½?½?½?½?½?½?½?½?½?½?½?ãƒ‡?½?½[?½?½^
	/********** ?½?½o?½?½X?½?½C?½?½?½?½?½?½^?½?½t?½?½F?½?½[?½?½X **********/
	input  wire [`WORD_MSB:0] bus_rd_data, // ?½?½??¿å‡º?½?½?½?½?½?½f?½?½[?½?½^
	input  wire				   bus_rdy_,	// ?½?½?½?½?½?½f?½?½B
	input  wire				   bus_grnt_,	// ?½?½o?½?½X?½?½O?½?½?½?½?½?½?½?½?½?½g
	output wire				   bus_req_,	// ?½?½o?½?½X?½?½?½?½?½?½N?½?½G?½?½X?½?½g
	output wire [`WORD_ADDR_MSB:0] bus_addr,	// ?½?½A?½?½h?½?½?½?½?½?½X
	output wire				   bus_as_,		// ?½?½A?½?½h?½?½?½?½?½?½X?½?½X?½?½g?½?½?½?½?½?½[?½?½u
	output wire				   bus_rw,		// ?½?½??¿?ï¿½?½?½?½?½?½?½?½
	output wire [`WORD_MSB:0] bus_wr_data, // ?½?½?½?½?½?½?½?½?½?½?½?½?½?½?ãƒ‡?½?½[?½?½^
	/********** ?½?½p?½?½C?½?½v?½?½?½?½?½?½C?½?½?½?½?½?½?½?½?½?½?½?½?½?½M?½?½?½?½ **********/
	input  wire				   stall,		// ?½?½X?½?½g?½?½[?½?½?½?½
	input  wire				   flush,		// ?½?½t?½?½?½?½?½?½b?½?½V?½?½?½?½
	input  wire [`WORD_ADDR_MSB:0] new_pc,		// ?½?½V?½?½?½?½?½?½?½?½?½?½v?½?½?½?½?½?½O?½?½?½?½?½?½?½?½?½?½J?½?½E?½?½?½?½?½?½^
	input  wire				   br_taken,	// ?½?½?½?½?½?½?½?½?½?½?Œæ’°?¿?½?½?½?½?½
	input  wire [`WORD_ADDR_MSB:0] br_addr,		// ?½?½?½?½?½?½?½?½?½?½?½?½?½?½A?½?½h?½?½?½?½?½?½X
	output wire				   busy,		// ?½?½r?½?½W?½?½[?½?½M?½?½?½?½
	/********** IF/ID?½?½p?½?½C?½?½v?½?½?½?½?½?½C?½?½?½?½?½?½?½?½?½?½W?½?½X?½?½^ **********/
	output wire [`WORD_ADDR_MSB:0] if_pc,		// ?½?½v?½?½?½?½?½?½O?½?½?½?½?½?½?½?½?½?½J?½?½E?½?½?½?½?½?½^
	output wire [`WORD_MSB:0] if_insn,		// ?½?½?½?½?½?½?½?½
	output wire				   if_en		// ?½?½p?½?½C?½?½v?½?½?½?½?½?½C?½?½?½?½?½?½f?½?½[?½?½^?½?½?Œæœ‰?½?½?½?½
);

	/********** ?½?½?½?½?½?½?½?½?½?½?šæ‰˜?¿?½?½?½M?½?½?½?½ **********/
	wire [`WORD_MSB:0]		   insn;		// ?½?½t?½?½F?½?½b?½?½`?½?½?½?½?½?½?½?½?½?½?½?½?½?½?½?½

	/********** ?½?½o?½?½X?½?½C?½?½?½?½?½?½^?½?½t?½?½F?½?½[?½?½X **********/
	bus_IF bus_if (
		/********** ?½?½N?½?½?½?½?½?½b?½?½N & ?½?½?½?½?½?½Z?½?½b?½?½g **********/
		.clk		 (clk),					// ?½?½N?½?½?½?½?½?½b?½?½N
		.rst		 (reset),				// ?½?½û Žï½¯å¥?½¿?½?½?½?½?½?½?½Z?½?½b?½?½g
		/********** ?½?½p?½?½C?½?½v?½?½?½?½?½?½C?½?½?½?½?½?½?½?½?½?½?½?½?½?½M?½?½?½?½ **********/
		.stall		 (stall),				// ?½?½X?½?½g?½?½[?½?½?½?½
		.flush		 (flush),				// ?½?½t?½?½?½?½?½?½b?½?½V?½?½?½?½?½?½M?½?½?½?½
		.busy		 (busy),				// ?½?½r?½?½W?½?½[?½?½M?½?½?½?½
		/********** CPU?½?½C?½?½?½?½?½?½^?½?½t?½?½F?½?½[?½?½X **********/
		.addr		 (if_pc),				// ?½?½A?½?½h?½?½?½?½?½?½X
		.as		 (1),			// ?½?½A?½?½h?½?½?½?½?½?½X?½?½L?½?½?½?½
		.rw			 (0),				// ?½?½??¿?ï¿½?½?½?½?½?½?½?½
		.wr_data	 (0),		// ?½?½?½?½?½?½?½?½?½?½?½?½?½?½?ãƒ‡?½?½[?½?½^
		.rd_data	 (insn),				// ?½?½??¿å‡º?½?½?½?½?½?½f?½?½[?½?½^
		/********** ?½?½X?½?½N?½?½?½?½?½?½b?½?½`?½?½p?½?½b?½?½h?½?½?½?½?½?½?½?½?½?½?½?½?½?½C?½?½?½?½?½?½^?½?½t?½?½F?½?½[?½?½X **********/
		.spm_rd_data (spm_rd_data),			// ?½?½??¿å‡º?½?½?½?½?½?½f?½?½[?½?½^
		.spm_addr	 (spm_addr),			// ?½?½A?½?½h?½?½?½?½?½?½X
		.spm_as	 (spm_as_),				// ?½?½A?½?½h?½?½?½?½?½?½X?½?½X?½?½g?½?½?½?½?½?½[?½?½u
		.spm_rw		 (spm_rw),				// ?½?½??¿?ï¿½?½?½?½?½?½?½?½
		.spm_wr_data (spm_wr_data),			// ?½?½?½?½?½?½?½?½?½?½?½?½?½?½?ãƒ‡?½?½[?½?½^
		/********** ?½?½o?½?½X?½?½C?½?½?½?½?½?½^?½?½t?½?½F?½?½[?½?½X **********/
		.bus_rd_data (bus_rd_data),			// ?½?½??¿å‡º?½?½?½?½?½?½f?½?½[?½?½^
		.bus_rdy	 (bus_rdy_),			// ?½?½?½?½?½?½f?½?½B
		.bus_grnt	 (bus_grnt_),			// ?½?½o?½?½X?½?½O?½?½?½?½?½?½?½?½?½?½g
		.bus_req	 (bus_req_),			// ?½?½o?½?½X?½?½?½?½?½?½N?½?½G?½?½X?½?½g
		.bus_addr	 (bus_addr),			// ?½?½A?½?½h?½?½?½?½?½?½X
		.bus_as	 (bus_as_),				// ?½?½A?½?½h?½?½?½?½?½?½X?½?½X?½?½g?½?½?½?½?½?½[?½?½u
		.bus_rw		 (bus_rw),				// ?½?½??¿?ï¿½?½?½?½?½?½?½?½
		.bus_wr_data (bus_wr_data)			// ?½?½?½?½?½?½?½?½?½?½?½?½?½?½?ãƒ‡?½?½[?½?½^
	);

	/********** IF?½?½X?½?½e?½?½[?½?½W?½?½p?½?½C?½?½v?½?½?½?½?½?½C?½?½?½?½?½?½?½?½?½?½W?½?½X?½?½^ **********/
	reg_IF if_reg (
		/********** ?½?½N?½?½?½?½?½?½b?½?½N & ?½?½?½?½?½?½Z?½?½b?½?½g **********/
		.clk		 (clk),					// ?½?½N?½?½?½?½?½?½b?½?½N
		.rst		 (reset),				// ?½?½û Žï½¯å¥?½¿?½?½?½?½?½?½?½Z?½?½b?½?½g
		/********** ?½?½t?½?½F?½?½b?½?½`?½?½f?½?½[?½?½^ **********/
		.inst		 (insn),				// ?½?½t?½?½F?½?½b?½?½`?½?½?½?½?½?½?½?½?½?½?½?½?½?½?½?½
		/********** ?½?½p?½?½C?½?½v?½?½?½?½?½?½C?½?½?½?½?½?½?½?½?½?½?½?½?½?½M?½?½?½?½ **********/
		.stall		 (stall),				// ?½?½X?½?½g?½?½[?½?½?½?½
		.flush		 (flush),				// ?½?½t?½?½?½?½?½?½b?½?½V?½?½?½?½
		.new_pc		 (new_pc),				// ?½?½V?½?½?½?½?½?½?½?½?½?½v?½?½?½?½?½?½O?½?½?½?½?½?½?½?½?½?½J?½?½E?½?½?½?½?½?½^
		.br_taken	 (br_taken),			// ?½?½?½?½?½?½?½?½?½?½?Œæ’°?¿?½?½?½?½?½
		.br_addr	 (br_addr),				// ?½?½?½?½?½?½?½?½?½?½?½?½?½?½A?½?½h?½?½?½?½?½?½X
		/********** IF/ID?½?½p?½?½C?½?½v?½?½?½?½?½?½C?½?½?½?½?½?½?½?½?½?½W?½?½X?½?½^ **********/
		.if_pc		 (if_pc),				// ?½?½v?½?½?½?½?½?½O?½?½?½?½?½?½?½?½?½?½J?½?½E?½?½?½?½?½?½^
		.if_inst	 (if_insn),				// ?½?½?½?½?½?½?½?½
		.if_en		 (if_en)				// ?½?½p?½?½C?½?½v?½?½?½?½?½?½C?½?½?½?½?½?½f?½?½[?½?½^?½?½?Œæœ‰?½?½?½?½
	);

endmodule
