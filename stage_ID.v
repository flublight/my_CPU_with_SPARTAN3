`timescale 1ns / 1ps
//////////////////////////////////////////////////////////////////////////////////
// Company:
// Engineer:
//
// Create Date: 2018/03/08 17:54:41
// Design Name:
// Module Name: stage_ID
// Project Name:
// Target Devices:
// Tool Versions:
// Description:
//
// Dependencies:
//
// Revision:
// Revision 0.01 - File Created
// Additional Comments:
//
//////////////////////////////////////////////////////////////////////////////////


//inst_op
`define OP_ANDR		   6'h00 // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隲也炊?ｽ?ｽ?
`define OP_ANDI		   6'h01 // 繝ｬ繧ｸ繧ｹ繧ｿ縺ｨ螳壽焚縺ｮ隲也炊?ｽ?ｽ?
`define OP_ORR		   6'h02 // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隲也炊?ｽ?ｽ?
`define OP_ORI		   6'h03 // 繝ｬ繧ｸ繧ｹ繧ｿ縺ｨ螳壽焚縺ｮ隲也炊?ｽ?ｽ?
`define OP_XORR		   6'h04 // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ謗剃ｻ也噪隲也炊?ｽ?ｽ?
`define OP_XORI		   6'h05 // 繝ｬ繧ｸ繧ｹ繧ｿ縺ｨ螳壽焚縺ｮ謗剃ｻ也噪隲也炊?ｽ?ｽ?
`define OP_ADDSR	   6'h06 // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隨ｦ蜿ｷ莉倥″?ｽ?ｽ??ｽ?
`define OP_ADDSI	   6'h07 // 繝ｬ繧ｸ繧ｹ繧ｿ縺ｨ螳壽焚縺ｮ隨ｦ蜿ｷ莉倥″?ｽ?ｽ??ｽ?
`define OP_ADDUR	   6'h08 // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隨ｦ蜿ｷ縺ｪ縺怜刈?ｽ?ｽ?
`define OP_ADDUI	   6'h09 // 繝ｬ繧ｸ繧ｹ繧ｿ縺ｨ螳壽焚縺ｮ隨ｦ蜿ｷ縺ｪ縺怜刈?ｽ?ｽ?
`define OP_SUBSR	   6'h0a // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隨ｦ蜿ｷ莉倥″貂幢ｿｽ?ｽ?
`define OP_SUBUR	   6'h0b // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隨ｦ蜿ｷ縺ｪ縺玲ｸ幢ｿｽ?ｽ?
`define OP_SHRLR	   6'h0c // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隲也炊蜿ｳ繧ｷ繝輔ヨ
`define OP_SHRLI	   6'h0d // 繝ｬ繧ｸ繧ｹ繧ｿ縺ｨ螳壽焚縺ｮ隲也炊蜿ｳ繧ｷ繝輔ヨ
`define OP_SHLLR	   6'h0e // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隲也炊蟾ｦ繧ｷ繝輔ヨ
`define OP_SHLLI	   6'h0f // 繝ｬ繧ｸ繧ｹ繧ｿ縺ｨ螳壽焚縺ｮ隲也炊蟾ｦ繧ｷ繝輔ヨ
`define OP_BE		     6'h10 // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隨ｦ蜿ｷ莉倥″豈費ｿｽ?ｽ?==)
`define OP_BNE		   6'h11 // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隨ｦ蜿ｷ莉倥″豈費ｿｽ?ｽ?!=)
`define OP_BSGT		   6'h12 // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隨ｦ蜿ｷ莉倥″豈費ｿｽ?ｽ?<)
`define OP_BUGT		   6'h13 // 繝ｬ繧ｸ繧ｹ繧ｿ蜷悟｣ｫ縺ｮ隨ｦ蜿ｷ縺ｪ縺玲ｯ費ｿｽ?ｽ?<)
`define OP_JMP		   6'h14 // 繝ｬ繧ｸ繧ｹ繧ｿ?ｽ?ｽ??ｽ?ｽ?ｽ?邨ｶ蟇ｾ?ｽ?ｽ??ｽ?
`define OP_CALL		   6'h15 // 繝ｬ繧ｸ繧ｹ繧ｿ?ｽ?ｽ??ｽ?ｽ?ｽ?繧ｵ繝悶Ν繝ｼ繝√Φ繧ｳ繝ｼ繝ｫ
`define OP_LDW		   6'h16 // 繝ｯ繝ｼ繝芽ｪｭ縺ｿ蜃ｺ?ｽ?ｽ?
`define OP_STW		   6'h17 // 繝ｯ繝ｼ繝画嶌縺崎ｾｼ縺ｿ
`define OP_TRAP		   6'h18 // 繝医Λ?ｽ?ｽ??
`define OP_RDCR		   6'h19 // 蛻ｶ蠕｡繝ｬ繧ｸ繧ｹ繧ｿ縺ｮ隱ｭ縺ｿ蜃ｺ?ｽ?ｽ?
`define OP_WRCR		   6'h1a // 蛻ｶ蠕｡繝ｬ繧ｸ繧ｹ繧ｿ縺ｸ縺ｮ譖ｸ縺崎ｾｼ縺ｿ
`define OP_EXRT		   6'h1b // 萓句､悶°繧会ｿｽ?蠕ｩ蟶ｰ


//ALU Operation
`define ALU_OP_NOP			 4'h0 // No Operation
`define ALU_OP_AND			 4'h1 // AND
`define ALU_OP_OR			 4'h2 // OR
`define ALU_OP_XOR			 4'h3 // XOR
`define ALU_OP_ADDS			 4'h4 // 隨ｦ蜿ｷ莉倥″?ｽ?ｽ??ｽ?
`define ALU_OP_ADDU			 4'h5 // 隨ｦ蜿ｷ縺ｪ縺怜刈?ｽ?ｽ?
`define ALU_OP_SUBS			 4'h6 // 隨ｦ蜿ｷ莉倥″貂幢ｿｽ?ｽ?
`define ALU_OP_SUBU			 4'h7 // 隨ｦ蜿ｷ縺ｪ縺玲ｸ幢ｿｽ?ｽ?
`define ALU_OP_SHRL			 4'h8 // 隲也炊蜿ｳ繧ｷ繝輔ヨ
`define ALU_OP_SHLL			 4'h9 // 隲也炊蟾ｦ繧ｷ繝輔ヨ

//exec mode
`define CPU_KERNEL_MODE 0

`define EXP_NO_EXP	   3'h0	 // 萓句､悶↑?ｽ?ｽ?
`define EXP_EXT_INT	   3'h1	 // 螟夜Κ蜑ｲ繧願ｾｼ縺ｿ
`define EXP_UNDEF_INSN 3'h2	 // 譛ｪ螳夂ｾｩ蜻ｽ莉､
`define EXP_OVERFLOW   3'h3	 // 邂苓｡薙が繝ｼ繝舌ヵ繝ｭ繝ｼ
`define EXP_MISS_ALIGN 3'h4	 // 繧｢繝峨Ξ繧ｹ繝溘せ繧｢繝ｩ繧､繝ｳ
`define EXP_TRAP	   3'h5	 // 繝医Λ?ｽ?ｽ??
`define EXP_PRV_VIO	   3'h6	 // 迚ｹ讓ｩ驕募渚

/*
mem_op
0:NOP
1:LDW
2:STW
*/

`define WORD 32  // 1word
`define WORD_ADDR_W 30  // address width 1word

`define GPR_ADDR_MSB 5-1

`define WORD_MSB `WORD-1
`define WORD_ADDR_MSB `WORD_ADDR_W-1
`define RegAddrBus `GPR_ADDR_MSB:0

module decoder_ID (
	input [`WORD_ADDR_MSB:0]if_pc,
	input [`WORD_MSB:0]if_inst,
	input if_en,

	input[`WORD_MSB:0] gpr_rd_data_0,
	input[`WORD_MSB:0] gpr_rd_data_1,
	output [`GPR_ADDR_MSB:0] gpr_addr_data_0,
	output [`GPR_ADDR_MSB:0] gpr_addr_data_1,

	input id_en,
	input [`GPR_ADDR_MSB:0]id_dst_addr,
	input id_gpr_we,
	input [1:0]id_mem_op,

    input ex_en,
    input [`GPR_ADDR_MSB:0]ex_dst_addr,
    input ex_gpr_we,
    input [`WORD_MSB:0]ex_fwd_data,

    input [`WORD_MSB:0]mem_fwd_data,

    input exe_mode,
	input [`WORD_MSB:0]creg_rd_data,
	output reg[`GPR_ADDR_MSB:0] creg_rd_addr,

	output reg[3:0] alu_op,
	output reg[`WORD_MSB:0] alu_in_0,
	output reg[`WORD_MSB:0] alu_in_1,
	output reg[`WORD_ADDR_MSB:0] br_addr,
	output reg br_taken,
	output reg br_flag,
	output reg[1:0] mem_op,
	output reg[`WORD_MSB:0] mem_wr_data,
	output reg [1:0]ctrl_op,
	output reg [`GPR_ADDR_MSB:0]dst_addr,
	output reg gpr_we,
  output reg[2:0] exp_code,
  output reg ld_hazard
    );

    wire[5:0] op=if_inst[31:26];
    wire[4:0] ra_addr=if_inst[25:21],rb_addr=if_inst[20:16],rc_addr=if_inst[15:11];
    wire[15:0]imm=if_inst[15:0];

    wire[`WORD_MSB:0]imm_s={{16{imm[15]}},imm};//signed
    wire[`WORD_MSB:0]imm_u={16'b0,imm};//unsigned

     reg[`WORD_MSB:0]ra;
     wire signed[`WORD_MSB:0]s_ra=$signed(ra);
     reg[`WORD_MSB:0]rb;
     wire signed[`WORD_ADDR_MSB:0]s_rb=$signed(rb);//signed

     wire[`WORD_ADDR_MSB:0]ret_addr=if_pc+1;
     wire[`WORD_ADDR_MSB:0]br_target=if_pc+imm_s[`WORD_ADDR_MSB:0];
     wire[`WORD_ADDR_MSB:0]jmp_target=ra[`WORD_ADDR_MSB:0];

		 //fowording
		 always @ ( * ) begin
		 //ra regster
		 	if(id_en &&id_gpr_we && id_dst_addr==ra_addr) ra=ex_fwd_data;
			else if(ex_en &&ex_gpr_we && ex_dst_addr==ra_addr) ra=mem_fwd_data;
			else ra=gpr_rd_data_0;

			//rb regster
 		 	if(id_en &&id_gpr_we && id_dst_addr==rb_addr) rb=ex_fwd_data;
 			else if(ex_en &&ex_gpr_we && ex_dst_addr==rb_addr) rb=mem_fwd_data;
 			else rb=gpr_rd_data_1;
		 end

		 //detect load ld_hazard
		 always @ ( * ) begin
		 	if(id_en && id_mem_op ==1&& (id_dst_addr==ra_addr||id_dst_addr==rb_addr))ld_hazard=1;
			else ld_hazard=0;
		 end

		 //instraction decoder
		 always @ ( * ) begin
		 	alu_op=0;
			alu_in_0=ra;
			alu_in_1=rb;
			br_taken=0;
			br_flag=0;
			mem_op=0;
			ctrl_op=0;
			dst_addr=rb_addr;//R2
			gpr_we=0;
			exp_code=0;

			if (if_en == 1) begin
				case (op)
					/* ??ｽ_??ｽ??ｽ??ｽ??ｽ??ｽZ??ｽ??ｽ??ｽ??ｽ */
					`OP_ANDR  : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ論??ｽ??ｽ??ｽ??ｽ
						alu_op	 = `ALU_OP_AND;
						dst_addr = rc_addr;
						gpr_we	 = 1;
					end
					`OP_ANDI  : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽﾆ托ｿｽ??ｽl??ｽﾌ論??ｽ??ｽ??ｽ??ｽ
						alu_op	 = `ALU_OP_AND;
						alu_in_1 = imm_u;
						gpr_we	 = 1;
					end
					`OP_ORR	  : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ論??ｽ??ｽ??ｽa
						alu_op	 = `ALU_OP_OR;
						dst_addr = rc_addr;
						gpr_we	 = 1;
					end
					`OP_ORI	  : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽﾆ托ｿｽ??ｽl??ｽﾌ論??ｽ??ｽ??ｽa
						alu_op	 = `ALU_OP_OR;
						alu_in_1 = imm_u;
						gpr_we	 = 1;
					end
					`OP_XORR  : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ排??ｽ??ｽ??ｽI??ｽ_??ｽ??ｽ??ｽa
						alu_op	 = `ALU_OP_XOR;
						dst_addr = rc_addr;
						gpr_we	 = 1;
					end
					`OP_XORI  : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽﾆ托ｿｽ??ｽl??ｽﾌ排??ｽ??ｽ??ｽI??ｽ_??ｽ??ｽ??ｽa
						alu_op	 = `ALU_OP_XOR;
						alu_in_1 = imm_u;
						gpr_we	 = 1;
					end
					/* ??ｽZ??ｽp??ｽ??ｽ??ｽZ??ｽ??ｽ??ｽ??ｽ */
					`OP_ADDSR : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ包ｿｽ??ｽ??ｽ??ｽt??ｽ??ｽ??ｽ??ｽ??ｽZ
						alu_op	 = `ALU_OP_ADDS;
						dst_addr = rc_addr;
						gpr_we	 = 1;
					end
					`OP_ADDSI : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽﾆ托ｿｽ??ｽl??ｽﾌ包ｿｽ??ｽ??ｽ??ｽt??ｽ??ｽ??ｽ??ｽ??ｽZ
						alu_op	 = `ALU_OP_ADDS;
						alu_in_1 = imm_s;
						gpr_we	 = 1;
					end
					`OP_ADDUR : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ包ｿｽ??ｽ??ｽ??ｽﾈゑｿｽ??ｽ??ｽ??ｽZ
						alu_op	 = `ALU_OP_ADDU;
						dst_addr = rc_addr;
						gpr_we	 = 1;
					end
					`OP_ADDUI : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽﾆ托ｿｽ??ｽl??ｽﾌ包ｿｽ??ｽ??ｽ??ｽﾈゑｿｽ??ｽ??ｽ??ｽZ
						alu_op	 = `ALU_OP_ADDU;
						alu_in_1 = imm_s;
						gpr_we	 = 1;
					end
					`OP_SUBSR : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ包ｿｽ??ｽ??ｽ??ｽt??ｽ??ｽ??ｽ??ｽ??ｽZ
						alu_op	 = `ALU_OP_SUBS;
						dst_addr = rc_addr;
						gpr_we	 = 1;
					end
					`OP_SUBUR : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ包ｿｽ??ｽ??ｽ??ｽﾈゑｿｽ??ｽ??ｽ??ｽZ
						alu_op	 = `ALU_OP_SUBU;
						dst_addr = rc_addr;
						gpr_we	 = 1;
					end
					/* ??ｽV??ｽt??ｽg??ｽ??ｽ??ｽ??ｽ */
					`OP_SHRLR : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ論??ｽ??ｽ??ｽE??ｽV??ｽt??ｽg
						alu_op	 = `ALU_OP_SHRL;
						dst_addr = rc_addr;
						gpr_we	 = 1;
					end
					`OP_SHRLI : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽﾆ托ｿｽ??ｽl??ｽﾌ論??ｽ??ｽ??ｽE??ｽV??ｽt??ｽg
						alu_op	 = `ALU_OP_SHRL;
						alu_in_1 = imm_u;
						gpr_we	 = 1;
					end
					`OP_SHLLR : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ論??ｽ??ｽ??ｽ??ｽ??ｽV??ｽt??ｽg
						alu_op	 = `ALU_OP_SHLL;
						dst_addr = rc_addr;
						gpr_we	 = 1;
					end
					`OP_SHLLI : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽﾆ托ｿｽ??ｽl??ｽﾌ論??ｽ??ｽ??ｽ??ｽ??ｽV??ｽt??ｽg
						alu_op	 = `ALU_OP_SHLL;
						alu_in_1 = imm_u;
						gpr_we	 = 1;
					end
					/* ??ｽ??ｽ??ｽ命暦ｿｽ */
					`OP_BE	  : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ包ｿｽ??ｽ??ｽ??ｽt??ｽ??ｽ??ｽ??ｽ??ｽr??ｽiRa == Rb??ｽj
						br_addr	 = br_target;
						br_taken = (ra == rb) ? 1 : 0;
						br_flag	 = 1;
					end
					`OP_BNE	  : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ包ｿｽ??ｽ??ｽ??ｽt??ｽ??ｽ??ｽ??ｽ??ｽr??ｽiRa != Rb??ｽj
						br_addr	 = br_target;
						br_taken = (ra != rb) ? 1 : 0;
						br_flag	 = 1;
					end
					`OP_BSGT  : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ包ｿｽ??ｽ??ｽ??ｽt??ｽ??ｽ??ｽ??ｽ??ｽr??ｽiRa < Rb??ｽj
						br_addr	 = br_target;
						br_taken = (s_ra < s_rb) ? 1 : 0;
						br_flag	 = 1;
					end
					`OP_BUGT  : begin // ??ｽ??ｽ??ｽW??ｽX??ｽ^??ｽ??ｽ??ｽm??ｽﾌ包ｿｽ??ｽ??ｽ??ｽﾈゑｿｽ??ｽ??ｽ??ｽr??ｽiRa < Rb??ｽj
						br_addr	 = br_target;
						br_taken = (ra < rb) ? 1 : 0;
						br_flag	 = 1;
					end
					`OP_JMP	  : begin // ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ
						br_addr	 = jmp_target;
						br_taken = 1;
						br_flag	 = 1;
					end
					`OP_CALL  : begin // ??ｽR??ｽ[??ｽ??ｽ
						alu_in_0 = {ret_addr, {2{1'b0}}};
						br_addr	 = jmp_target;
						br_taken = 1;
						br_flag	 = 1;
						dst_addr = 5'd31;
						gpr_we	 = 1;
					end
					/* ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽA??ｽN??ｽZ??ｽX??ｽ??ｽ??ｽ??ｽ */
					`OP_LDW	  : begin // ??ｽ??ｽ??ｽ[??ｽh??ｽﾇみ出??ｽ??ｽ
						alu_op	 = `ALU_OP_ADDU;
						alu_in_1 = imm_s;
						mem_op	 = 1;
						gpr_we	 = 1;
					end
					`OP_STW	  : begin // ??ｽ??ｽ??ｽ[??ｽh??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ
						alu_op	 = `ALU_OP_ADDU;
						alu_in_1 = imm_s;
						mem_op	 = 2;
					end
					/* ??ｽV??ｽX??ｽe??ｽ??ｽ??ｽR??ｽ[??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ */
					`OP_TRAP  : begin // ??ｽg??ｽ??ｽ??ｽb??ｽv
						exp_code = `EXP_TRAP;
					end
					/* ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ */
					`OP_RDCR  : begin // ??ｽ??ｽ??ｽ艫鯉ｿｽW??ｽX??ｽ^??ｽﾌ読み出??ｽ??ｽ
						if (exe_mode == `CPU_KERNEL_MODE) begin
							alu_in_0 = creg_rd_data;
							gpr_we	 = 1;
						end else begin
							exp_code = `EXP_PRV_VIO;
						end
					end
					`OP_WRCR  : begin // ??ｽ??ｽ??ｽ艫鯉ｿｽW??ｽX??ｽ^??ｽﾖの擾ｿｽ??ｽ??ｽ??ｽ??ｽ??ｽ??ｽ
						if (exe_mode == `CPU_KERNEL_MODE) begin
							ctrl_op	 = 1; //write ctrl reg
						end else begin
							exp_code = `EXP_PRV_VIO;
						end
					end
					`OP_EXRT  : begin // ??ｽ??ｽ??ｽO??ｽ??ｽ??ｽ??ｽ??ｽﾌ包ｿｽ??ｽA
						if (exe_mode == `CPU_KERNEL_MODE) begin
							ctrl_op	 = 2;//return from exception
						end else begin
							exp_code = `EXP_PRV_VIO;
						end
					end
					/* ??ｽ??ｽ??ｽﾌ托ｿｽ??ｽﾌ厄ｿｽ??ｽ??ｽ */
					default		  : begin // ??ｽ??ｽ??ｽ??ｽ??ｽ`??ｽ??ｽ??ｽ??ｽ
						exp_code = `EXP_UNDEF_INSN;
					end
				endcase
			end
		 end

endmodule //decoder_ID


module reg_ID (
	input clk,
	input rst,

	output reg[3:0] alu_op,
	output reg[`WORD_MSB:0] alu_in_0,
	output reg[`WORD_MSB:0] alu_in_1,
	output reg[`WORD_ADDR_MSB:0] br_addr,
	output reg br_flag,
	output reg[1:0] mem_op,
	output reg[`WORD_MSB:0] mem_wr_data,
	output reg [1:0]ctrl_op,
	output reg [`GPR_ADDR_MSB:0]dst_addr,
	output reg gpr_we,
	input[2:0] exp_code,

    input stall,
    input flush,

	input [`WORD_ADDR_MSB:0]if_pc,
	input if_en,

	output reg [`WORD_ADDR_MSB:0]id_pc,
	output reg id_en,

	output reg[3:0] id_alu_op,
	output reg[`WORD_MSB:0] id_alu_in_0,
	output reg[`WORD_MSB:0] id_alu_in_1,
	output reg id_br_flag,

	output reg [1:0]id_mem_op,
	output reg [`GPR_ADDR_MSB:0]id_mem_wr_data,

	output reg [1:0] id_ctrl_op,
	output reg [`GPR_ADDR_MSB:0]id_dst_addr,

	output reg id_gpr_we,
  output reg [1:0]id_exp_code

    );


		  always@(posedge clk or negedge rst)begin//bus access control
		    if(~rst)begin
		      id_pc<=0;
		      id_en<=0;
					id_alu_op<=0;
					id_alu_in_0<=0;
					id_alu_in_1<=0;
					id_br_flag<=0;
					id_mem_op<=0;
					id_mem_wr_data<=0;
					id_ctrl_op<=0;
					id_dst_addr<=0;
					id_gpr_we<=0;
					id_exp_code<=0;
				end
		    else if(~stall)begin
					if(flush)begin
						id_pc<=0;
		      	id_en<=0;
						id_alu_op<=0;
						id_alu_in_0<=0;
						id_alu_in_1<=0;
						id_br_flag<=0;
						id_mem_op<=0;
						id_mem_wr_data<=0;
						id_ctrl_op<=0;
						id_dst_addr<=0;
						id_gpr_we<=0;
						id_exp_code<=0;
					end
					else begin
						id_pc<=if_pc;
						id_en<=if_en;
						id_alu_op<=alu_op;
						id_alu_in_0<=alu_in_0;
						id_alu_in_1<=alu_in_1;
						id_br_flag<=br_flag;
						id_mem_op<=mem_op;
						id_mem_wr_data<=mem_wr_data;
						id_ctrl_op<=ctrl_op;
						id_dst_addr<=dst_addr;
						id_gpr_we<=gpr_we;
						id_exp_code<=exp_code;
					end
				end
			end
endmodule
module stage_ID(
	input  wire					 clk,			 // ?N???b?N
	input  wire					 reset,			 // ??????Z?b?g
	/********** GPR?C???^?t?F?[?X **********/
	input  wire [`WORD_MSB:0]	 gpr_rd_data_0,	 // ???o???f?[?^ 0
	input  wire [`WORD_MSB:0]	 gpr_rd_data_1,	 // ???o???f?[?^ 1
	output wire [`WORD_ADDR_MSB:0]	 gpr_rd_addr_0,	 // ???o???A?h???X 0
	output wire [`WORD_ADDR_MSB:0]	 gpr_rd_addr_1,	 // ???o???A?h???X 1
	/********** ?t?H???[?f?B???O **********/
	// EX?X?e?[?W??????t?H???[?f?B???O
	input  wire					 ex_en,			// ?p?C?v???C???f?[?^??L??
	input  wire [`WORD_MSB:0]	 ex_fwd_data,	 // ?t?H???[?f?B???O?f?[?^
	input  wire [`GPR_ADDR_MSB:0]	 ex_dst_addr,	 // ????????A?h???X
	input  wire					 ex_gpr_we_,	 // ????????L??
	// MEM?X?e?[?W??????t?H???[?f?B???O
	input  wire [`WORD_MSB:0]	 mem_fwd_data,	 // ?t?H???[?f?B???O?f?[?^
	/********** ?????W?X?^?C???^?t?F?[?X **********/
	input  wire exe_mode,		 // ???s???[?h
	input  wire [`WORD_MSB:0]	 creg_rd_data,	 // ???o???f?[?^
	output wire [`GPR_ADDR_MSB:0]	 creg_rd_addr,	 // ???o???A?h???X
	/********** ?p?C?v???C???????M?? **********/
	input  wire					 stall,			 // ?X?g?[??
	input  wire					 flush,			 // ?t???b?V??
	output wire [`WORD_ADDR_MSB:0]	 br_addr,		 // ?????A?h???X
	output wire					 br_taken,		 // ?????????
	output wire					 ld_hazard,		 // ???[?h?n?U?[?h
	/********** IF/ID?p?C?v???C?????W?X?^ **********/
	input  wire [`WORD_ADDR_MSB:0]	 if_pc,			 // ?v???O?????J?E???^
	input  wire [`WORD_MSB:0]	 if_insn,		 // ????
	input  wire					 if_en,			 // ?p?C?v???C???f?[?^??L??
	/********** ID/EX?p?C?v???C?????W?X?^ **********/
	output wire [`WORD_ADDR_MSB:0]	 id_pc,			 // ?v???O?????J?E???^
	output wire					 id_en,			 // ?p?C?v???C???f?[?^??L??
	output wire [3:0]		 id_alu_op,		 // ALU?I?y???[?V????
	output wire [`WORD_MSB:0]	 id_alu_in_0,	 // ALU???? 0
	output wire [`WORD_MSB:0]	 id_alu_in_1,	 // ALU???? 1
	output wire					 id_br_flag,	 // ?????t???O
	output wire [1:0]		 id_mem_op,		 // ???????I?y???[?V????
	output wire [`WORD_MSB:0]	 id_mem_wr_data, // ??????????????f?[?^
	output wire [1:0]	 id_ctrl_op,	 // ?????I?y???[?V????
	output wire [`GPR_ADDR_MSB:0]	 id_dst_addr,	 // GPR????????A?h???X
	output wire					 id_gpr_we_,	 // GPR????????L??
	output wire [5:0]	 id_exp_code	 // ???O?R?[?h
);

	/********** ?f?R?[?h?M?? **********/
	wire  [3:0]			 alu_op;		 // ALU?I?y???[?V????
	wire  [`WORD_MSB:0]		 alu_in_0;		 // ALU???? 0
	wire  [`WORD_MSB:0]		 alu_in_1;		 // ALU???? 1
	wire						 br_flag;		 // ?????t???O
	wire  [1:0]			 mem_op;		 // ???????I?y???[?V????
	wire  [`WORD_MSB:0]		 mem_wr_data;	 // ??????????????f?[?^
	wire  [1:0]			 ctrl_op;		 // ?????I?y???[?V????
	wire  [`GPR_ADDR_MSB:0]			 dst_addr;		 // GPR????????A?h???X
	wire						 gpr_we_;		 // GPR????????L??
	wire  [2:0]			 exp_code;		 // ???O?R?[?h

	/********** ?f?R?[?_ **********/
	decoder_ID decoder (
		/********** IF/ID?p?C?v???C?????W?X?^ **********/
		.if_pc			(if_pc),		  // ?v???O?????J?E???^
		.if_inst		(if_insn),		  // ????
		.if_en			(if_en),		  // ?p?C?v???C???f?[?^??L??
		/********** GPR?C???^?t?F?[?X **********/
		.gpr_rd_data_0	(gpr_rd_data_0),  // ???o???f?[?^ 0
		.gpr_rd_data_1	(gpr_rd_data_1),  // ???o???f?[?^ 1
		.gpr_rd_addr_0	(gpr_rd_addr_0),  // ???o???A?h???X 0
		.gpr_rd_addr_1	(gpr_rd_addr_1),  // ???o???A?h???X 1
		/********** ?t?H???[?f?B???O **********/
		// ID?X?e?[?W??????t?H???[?f?B???O
		.id_en			(id_en),		  // ?p?C?v???C???f?[?^??L??
		.id_dst_addr	(id_dst_addr),	  // ????????A?h???X
		.id_gpr_we		(id_gpr_we_),	  // ????????L??
		.id_mem_op		(id_mem_op),	  // ???????I?y???[?V????
		// EX?X?e?[?W??????t?H???[?f?B???O
		.ex_en			(ex_en),		  // ?p?C?v???C???f?[?^??L??
		.ex_fwd_data	(ex_fwd_data),	  // ?t?H???[?f?B???O?f?[?^
		.ex_dst_addr	(ex_dst_addr),	  // ????????A?h???X
		.ex_gpr_we		(ex_gpr_we_),	  // ????????L??
		// MEM?X?e?[?W??????t?H???[?f?B???O
		.mem_fwd_data	(mem_fwd_data),	  // ?t?H???[?f?B???O?f?[?^
		/********** ?????W?X?^?C???^?t?F?[?X **********/
		.exe_mode		(exe_mode),		  // ???s???[?h
		.creg_rd_data	(creg_rd_data),	  // ???o???f?[?^
		.creg_rd_addr	(creg_rd_addr),	  // ???o???A?h???X
		/********** ?f?R?[?h?M?? **********/
		.alu_op			(alu_op),		  // ALU?I?y???[?V????
		.alu_in_0		(alu_in_0),		  // ALU???? 0
		.alu_in_1		(alu_in_1),		  // ALU???? 1
		.br_addr		(br_addr),		  // ?????A?h???X
		.br_taken		(br_taken),		  // ?????????
		.br_flag		(br_flag),		  // ?????t???O
		.mem_op			(mem_op),		  // ???????I?y???[?V????
		.mem_wr_data	(mem_wr_data),	  // ??????????????f?[?^
		.ctrl_op		(ctrl_op),		  // ?????I?y???[?V????
		.dst_addr		(dst_addr),		  // ??p???W?X?^????????A?h???X
		.gpr_we		(gpr_we_),		  // ??p???W?X?^????????L??
		.exp_code		(exp_code),		  // ???O?R?[?h
		.ld_hazard		(ld_hazard)		  // ???[?h?n?U?[?h
	);

	/********** ?p?C?v???C?????W?X?^ **********/
	reg_ID id_reg (
		/********** ?N???b?N & ???Z?b?g **********/
		.clk			(clk),			  // ?N???b?N
		.rst			(reset),		  // ??????Z?b?g
		/********** ?f?R?[?h???? **********/
		.alu_op			(alu_op),		  // ALU?I?y???[?V????
		.alu_in_0		(alu_in_0),		  // ALU???? 0
		.alu_in_1		(alu_in_1),		  // ALU???? 1
		.br_flag		(br_flag),		  // ?????t???O
		.mem_op			(mem_op),		  // ???????I?y???[?V????
		.mem_wr_data	(mem_wr_data),	  // ??????????????f?[?^
		.ctrl_op		(ctrl_op),		  // ?????I?y???[?V????
		.dst_addr		(dst_addr),		  // ??p???W?X?^????????A?h???X
		.gpr_we		(gpr_we_),		  // ??p???W?X?^????????L??
		.exp_code		(exp_code),		  // ???O?R?[?h
		/********** ?p?C?v???C???????M?? **********/
		.stall			(stall),		  // ?X?g?[??
		.flush			(flush),		  // ?t???b?V??
		/********** IF/ID?p?C?v???C?????W?X?^ **********/
		.if_pc			(if_pc),		  // ?v???O?????J?E???^
		.if_en			(if_en),		  // ?p?C?v???C???f?[?^??L??
		/********** ID/EX?p?C?v???C?????W?X?^ **********/
		.id_pc			(id_pc),		  // ?v???O?????J?E???^
		.id_en			(id_en),		  // ?p?C?v???C???f?[?^??L??
		.id_alu_op		(id_alu_op),	  // ALU?I?y???[?V????
		.id_alu_in_0	(id_alu_in_0),	  // ALU???? 0
		.id_alu_in_1	(id_alu_in_1),	  // ALU???? 1
		.id_br_flag		(id_br_flag),	  // ?????t???O
		.id_mem_op		(id_mem_op),	  // ???????I?y???[?V????
		.id_mem_wr_data (id_mem_wr_data), // ??????????????f?[?^
		.id_ctrl_op		(id_ctrl_op),	  // ?????I?y???[?V????
		.id_dst_addr	(id_dst_addr),	  // ??p???W?X?^????????A?h???X
		.id_gpr_we		(id_gpr_we_),	  // ??p???W?X?^????????L??
		.id_exp_code	(id_exp_code)	  // ???O?R?[?h
	);

endmodule
